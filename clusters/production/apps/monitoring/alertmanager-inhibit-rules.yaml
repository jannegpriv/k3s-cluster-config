apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-inhibit-rules
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
data:
  alertmanager.yaml: |-
    global:
      resolve_timeout: 5m
      smtp:
        smarthost: smtp-relay.brevo.com:587
        from: jannegpriv@gmail.com
        auth_username: 85deaf001@smtp-brevo.com
        auth_password: ${SMTP_PASSWORD}
        require_tls: true
    
    route:
      group_by: ['alertname', 'job']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 6h
      receiver: 'email'
      routes:
      - match:
          severity: none
        receiver: 'null'
      - match:
          severity: warning
        receiver: 'email'
      - match:
          severity: critical
        receiver: 'email'
    
    inhibit_rules:
      # Inhibit alerts for embedded K3s components
      - source_match:
          alertname: 'K3sComponentsInhibitor'
        target_match_re:
          alertname: 'KubeControllerManagerDown|KubeSchedulerDown|KubeProxyDown'
        equal: ['job']
      
      # Don't alert on NodeCPUThrottling if the node is already known to be under pressure
      - source_match:
          alertname: 'NodeHighCPULoad'
        target_match:
          alertname: 'NodeCPUThrottlingHigh'
        equal: ['instance']
    
    receivers:
    - name: 'null'
    - name: 'email'
      email_configs:
      - to: 'jannegpriv@gmail.com'
        send_resolved: true
        from: 'jannegpriv@gmail.com'
        smarthost: smtp-relay.brevo.com:587
        auth_username: 85deaf001@smtp-brevo.com
        auth_password: ${SMTP_PASSWORD}
        require_tls: true
