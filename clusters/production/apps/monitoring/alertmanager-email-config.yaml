apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: alertmanager-config
  namespace: monitoring
  labels:
    alertmanagerConfig: "true"
spec:
  receivers:
    - name: "null"
    - name: email
      emailConfigs:
        - to: jannegpriv@gmail.com
          from: jannegpriv@gmail.com
          smarthost: smtp-relay.brevo.com:587
          authUsername: 85deaf001@smtp-brevo.com
          authIdentity: 85deaf001@smtp-brevo.com
          authPassword:
            name: alertmanager-notification-secret
            key: password
          requireTLS: true
          sendResolved: true
    - name: n8n-webhook
      webhookConfigs:
        - url: "http://n8n.n8n/webhook/alertmanager"
          sendResolved: true
  route:
    # Group by more fields to combine related alerts
    groupBy: ['alertname', 'severity', 'job']
    # Wait longer before initial notification
    groupWait: 1m
    # Wait longer between notification groups
    groupInterval: 10m
    # Wait longer before repeating
    repeatInterval: 6h
    receiver: email
    routes:
      # Silence TargetDown for kube-proxy (false positive in k3s)
      - receiver: "null"
        matchers:
          - name: alertname
            value: TargetDown
          - name: job
            value: kube-proxy
        continue: false
      # Silence known k3s embedded component alerts
      - receiver: "null"
        matchers:
          - name: alertname
            value: KubeControllerManagerDown|KubeSchedulerDown|KubeProxyDown|K3sServiceDown
            regex: true
        continue: false
      # Route warning/critical alerts to both n8n and email
      - receiver: n8n-webhook
        matchers:
          - name: severity
            value: warning|critical
            regex: true
        continue: true
      - receiver: email
        matchers:
          - name: severity
            value: warning|critical
            regex: true
      # Drop alerts with severity=none
      - receiver: "null"
        matchers:
          - name: severity
            value: none
